pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
    skipDefaultCheckout(true)
  }

  triggers {
    githubPush()
  }

  environment {
    CONFTEST_VERSION = "0.56.0"
  }

  stages {

    stage('Checkout Code') {
      steps {
        checkout scm
      }
    }

    stage('Install Conftest') {
      steps {
        sh '''
          set -e

          OS=$(uname | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m)

          if [ "$ARCH" = "x86_64" ]; then
            ARCH="x86_64"
          elif [ "$ARCH" = "aarch64" ]; then
            ARCH="arm64"
          fi

          echo "Detected OS=$OS ARCH=$ARCH"

          curl -L -o conftest.tar.gz \
            https://github.com/open-policy-agent/conftest/releases/download/v${CONFTEST_VERSION}/conftest_${CONFTEST_VERSION}_${OS}_${ARCH}.tar.gz

          tar -xzf conftest.tar.gz
          chmod +x conftest
          ./conftest --version
        '''
      }
    }

    stage('Run Policy Tests') {
      steps {
        sh '''
          set -e

          echo "Running in repo root: $(pwd)"
          echo "Checking Gatekeeper folders..."

          if [ ! -d "01-eks-gatekeeper/tests" ]; then
            echo "❌ Missing folder: 01-eks-gatekeeper/tests"
            exit 1
          fi

          if [ ! -d "01-eks-gatekeeper/policies" ]; then
            echo "❌ Missing folder: 01-eks-gatekeeper/policies"
            exit 1
          fi

          # Conftest иштеши үчүн Rego (*.rego) керек.
          # Сенде азыр Gatekeeper YAML гана (Constraint/ConstraintTemplate) бар, ошон үчүн Rego жок болсо skip кылабыз.
          if find "01-eks-gatekeeper/policies" -type f -name "*.rego" | grep -q .; then
            echo "✅ Rego policies found. Running conftest..."
            ./conftest test 01-eks-gatekeeper/tests --policy 01-eks-gatekeeper/policies
          else
            echo "⚠️ No Rego policies found under 01-eks-gatekeeper/policies. Skipping conftest."
            echo "   (Gatekeeper YAML != Conftest Rego — бул нормалдуу.)"
          fi
        '''
      }
    }
  }

  post {
    success {
      echo "✅ Pipeline PASSED"
    }
    failure {
      echo "❌ Pipeline FAILED"
    }
    always {
      cleanWs()
    }
  }
}

